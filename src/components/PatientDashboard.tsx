import { useState, useEffect } from "react";
import { useLanguage } from "../contexts/LanguageContext";
import { Language } from "../translations";
import EnhancedVoiceAssistant from "./EnhancedVoiceAssistant";
import LanguageSelector from "./LanguageSelector";
import AIChatAssistant from "./AIChatAssistant";
import MovableFloatingButton from "./MovableFloatingButton";
import RemotePatientMonitoring from "./RemotePatientMonitoring";
import PatientEducationLibrary from "./PatientEducationLibrary";
import GovernmentNGODashboard from "./GovernmentNGODashboard";
import SidebarMenu from "./SidebarMenu";
import LoginPage from "./LoginPage";
import PatientSpecificDashboard from "./dashboards/PatientSpecificDashboard";
import DoctorSpecificDashboard from "./dashboards/DoctorSpecificDashboard";
import AdminSpecificDashboard from "./dashboards/AdminSpecificDashboard";
import SymptomChecker from "./SymptomChecker";
import HealthAnalytics from "./HealthAnalytics";
import MedicationManager from "./MedicationManager";
import EmergencySystem from "./EmergencySystem";
import AIHealthAssistant from "./AIHealthAssistant";
import PWAFeatures from "./PWAFeatures";
import IoTDeviceIntegration from "./IoTDeviceIntegration";
import GeneticHealthInsights from "./GeneticHealthInsights";
import PersonalizedWellnessCoaching from "./PersonalizedWellnessCoaching";

interface PatientData {
  name: string;
  age: number;
  abhaId: string;
  location: string;
  bloodGroup: string;
  emergencyContact: string;
  chronicConditions: string[];
  lastVisit: string;
  nextAppointment: string;
  medications: string[];
  allergies: string[];
  vitals: {
    heartRate: number;
    bloodPressure: string;
    temperature: number;
    oxygenSaturation: number;
    weight: number;
  };
}

interface UserInfo {
  type: "patient" | "doctor" | "admin";
  data: any;
}

interface PatientDashboardProps {
  user?: {
    userType: "patient" | "doctor" | "admin";
    name: string;
  };
}

export default function PatientDashboard({ user }: PatientDashboardProps) {
  const { currentLanguage, setLanguage } = useLanguage();
  const [currentSection, setCurrentSection] = useState("dashboard");
  const [showChat, setShowChat] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [sidebarHovered, setSidebarHovered] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());
  const [healthTip, setHealthTip] = useState("");
  const [userInfo, setUserInfo] = useState<UserInfo | null>(null);
  const [isLoggedIn, setIsLoggedIn] = useState(false);

  // Sample patient data
  const [patientData] = useState<PatientData>({
    name: "Rajesh Kumar",
    age: 45,
    abhaId: "ABHA-1234567890",
    location: "Village Rampur, District Bulandshahr, UP",
    bloodGroup: "B+",
    emergencyContact: "+91-9876543210",
    chronicConditions: ["Diabetes Type 2", "Hypertension"],
    lastVisit: "2024-01-15",
    nextAppointment: "2024-02-15",
    medications: ["Metformin 500mg", "Amlodipine 5mg"],
    allergies: ["Penicillin"],
    vitals: {
      heartRate: 78,
      bloodPressure: "130/85",
      temperature: 98.6,
      oxygenSaturation: 97,
      weight: 70,
    },
  });

  // Health tips rotation
  const healthTips = {
    english: [
      "ЁЯТз Drink at least 8 glasses of water daily to stay hydrated",
      "ЁЯЪ╢тАНтЩВя╕П Take a 30-minute walk daily to maintain heart health",
      "ЁЯеЧ Include fresh fruits and vegetables in every meal",
      "ЁЯШ┤ Get 7-8 hours of quality sleep for better immunity",
      "ЁЯзШтАНтЩАя╕П Practice deep breathing for 10 minutes daily to reduce stress",
    ],
    hindi: [
      "ЁЯТз рд╕реНрд╡рд╕реНрде рд░рд╣рдиреЗ рдХреЗ рд▓рд┐рдП рджрд┐рди рдореЗрдВ рдХрдо рд╕реЗ рдХрдо 8 рдЧрд┐рд▓рд╛рд╕ рдкрд╛рдиреА рдкрд┐рдПрдВ",
      "ЁЯЪ╢тАНтЩВя╕П рд╣реГрджрдп рд╕реНрд╡рд╛рд╕реНрдереНрдп рдХреЗ рд▓рд┐рдП рд░реЛрдЬ 30 рдорд┐рдирдЯ рдЯрд╣рд▓реЗрдВ",
      "ЁЯеЧ рд╣рд░ рднреЛрдЬрди рдореЗрдВ рддрд╛рдЬреЗ рдлрд▓ рдФрд░ рд╕рдмреНрдЬрд┐рдпрд╛рдВ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдВ",
      "ЁЯШ┤ рдмреЗрд╣рддрд░ рд░реЛрдЧ рдкреНрд░рддрд┐рд░реЛрдзрдХ рдХреНрд╖рдорддрд╛ рдХреЗ рд▓рд┐рдП 7-8 рдШрдВрдЯреЗ рдХреА рдЧреБрдгрд╡рддреНрддрд╛рдкреВрд░реНрдг рдиреАрдВрдж рд▓реЗрдВ",
      "ЁЯзШтАНтЩАя╕П рддрдирд╛рд╡ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░реЛрдЬ 10 рдорд┐рдирдЯ рдЧрд╣рд░реА рд╕рд╛рдВрд╕ рд▓реЗрдВ",
    ],
    tamil: [
      "ЁЯТз роЖро░рпЛроХрпНроХро┐ропрооро╛роХ роЗро░рпБроХрпНроХ родро┐ройроорпБроорпН роХрпБро▒рпИроирпНродродрпБ 8 роХро┐ро│ро╛ро╕рпН родрогрпНрогрпАро░рпН роХрпБроЯро┐роХрпНроХро╡рпБроорпН",
      "ЁЯЪ╢тАНтЩВя╕П роЗродроп роЖро░рпЛроХрпНроХро┐ропродрпНродро┐ро▒рпНроХро╛роХ родро┐ройроорпБроорпН 30 роиро┐рооро┐роЯроЩрпНроХро│рпН роироЯроХрпНроХро╡рпБроорпН",
      "ЁЯеЧ роТро╡рпНро╡рпКро░рпБ роЙрогро╡ро┐ро▓рпБроорпН рокрпБродро┐роп рокро┤роЩрпНроХро│рпН рооро▒рпНро▒рпБроорпН роХро╛ропрпНроХро▒ро┐роХро│рпН роЪрпЗро░рпНроХрпНроХро╡рпБроорпН",
      "ЁЯШ┤ роЪро┐ро▒роирпНрод роирпЛропрпН роОродро┐ро░рпНрокрпНрокрпБ роЪроХрпНродро┐роХрпНроХро╛роХ 7-8 роорогро┐ роирпЗро░ родро░рооро╛рой родрпВроХрпНроХроорпН",
      "ЁЯзШтАНтЩАя╕П роорой роЕро┤рпБродрпНродродрпНродрпИроХрпН роХрпБро▒рпИроХрпНроХ родро┐ройроорпБроорпН 10 роиро┐рооро┐роЯроЩрпНроХро│рпН роЖро┤рооро╛рой роорпВроЪрпНроЪрпБ",
    ],
  };

  // Update current time every minute
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 60000);
    return () => clearInterval(timer);
  }, []);

  // Rotate health tips every 10 seconds
  useEffect(() => {
    const tips =
      healthTips[currentLanguage as keyof typeof healthTips] ||
      healthTips.english;
    let tipIndex = 0;
    setHealthTip(tips[0]);

    const tipTimer = setInterval(() => {
      tipIndex = (tipIndex + 1) % tips.length;
      setHealthTip(tips[tipIndex]);
    }, 10000);

    return () => clearInterval(tipTimer);
  }, [currentLanguage]);

  const handleLogin = (
    userType: "patient" | "doctor" | "admin",
    userData: any,
  ) => {
    setUserInfo({ type: userType, data: userData });
    setIsLoggedIn(true);
    setCurrentSection("dashboard");
  };

  const handleQuickAction = (action: string) => {
    switch (action) {
      case "emergency":
        setCurrentSection("emergency");
        break;
      case "doctor":
        setCurrentSection("appointments");
        break;
      case "medicine":
        setCurrentSection("healthRecords");
        break;
      case "vitals":
        setCurrentSection("vitalsMonitoring");
        break;
      case "chat":
        setShowChat(true);
        break;
      default:
        console.log(`Action: ${action}`);
    }
  };

  const handleNavigation = (section: string) => {
    setCurrentSection(section);
    setShowChat(false);
  };

  const handleVoiceCommand = (command: string, _language: string) => {
    handleNavigation(command);
  };

  const getGreeting = () => {
    const hour = currentTime.getHours();
    const greetings = {
      english: {
        morning: "Good Morning",
        afternoon: "Good Afternoon",
        evening: "Good Evening",
      },
      hindi: {
        morning: "рд╕реБрдкреНрд░рднрд╛рдд",
        afternoon: "рдирдорд╕реНрдХрд╛рд░",
        evening: "рд╢реБрдн рд╕рдВрдзреНрдпрд╛",
      },
      tamil: {
        morning: "роХро╛ро▓рпИ ро╡рогроХрпНроХроорпН",
        afternoon: "роородро┐роп ро╡рогроХрпНроХроорпН",
        evening: "рооро╛ро▓рпИ ро╡рогроХрпНроХроорпН",
      },
    };

    const timeOfDay =
      hour < 12 ? "morning" : hour < 17 ? "afternoon" : "evening";
    const langGreetings =
      greetings[currentLanguage as keyof typeof greetings] || greetings.english;
    return langGreetings[timeOfDay];
  };

  const formatTime = () => {
    return currentTime.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  // Translation texts similar to LoginPage
  const texts = {
    english: {
      bookAppointment: "Book Appointment",
      appointmentBookingComingSoon: "Appointment booking feature coming soon...",
      telemedicine: "Telemedicine",
      videoConsultationComingSoon: "Video consultation feature coming soon...",
      logout: "Logout",
      tagline: "Your Family's Health, Just a Tap Away",
    },
    hindi: {
      bookAppointment: "рдЕрдкреЙрдЗрдВрдЯрдореЗрдВрдЯ рдмреБрдХ рдХрд░реЗрдВ",
      appointmentBookingComingSoon: "рдЕрдкреЙрдЗрдВрдЯрдореЗрдВрдЯ рдмреБрдХрд┐рдВрдЧ рд╕реБрд╡рд┐рдзрд╛ рдЬрд▓реНрдж рдЖ рд░рд╣реА рд╣реИ...",
      telemedicine: "рдЯреЗрд▓реАрдореЗрдбрд┐рд╕рд┐рди",
      videoConsultationComingSoon: "рд╡реАрдбрд┐рдпреЛ рдкрд░рд╛рдорд░реНрд╢ рд╕реБрд╡рд┐рдзрд╛ рдЬрд▓реНрдж рдЖ рд░рд╣реА рд╣реИ...",
      logout: "рд▓реЙрдЧрдЖрдЙрдЯ",
      tagline: "рдЖрдкрдХреЗ рдкрд░рд┐рд╡рд╛рд░ рдХрд╛ рд╕реНрд╡рд╛рд╕реНрдереНрдп, рдмрд╕ рдПрдХ рдЯреИрдк рджреВрд░",
    },
    tamil: {
      bookAppointment: "роЕрокрпНрокро╛ропро┐рогрпНроЯрпНроорпЖрогрпНроЯрпН рокрпБроХрпН роЪрпЖропрпНропрпБроЩрпНроХро│рпН",
      appointmentBookingComingSoon: "роЕрокрпНрокро╛ропро┐рогрпНроЯрпНроорпЖрогрпНроЯрпН рокрпБроХрпНроХро┐роЩрпН роЕроорпНроЪроорпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ ро╡ро░рпБроХро┐ро▒родрпБ...",
      telemedicine: "роЯрпЖро▓ро┐роорпЖроЯро┐роЪро┐ройрпН",
      videoConsultationComingSoon: "ро╡рпАроЯро┐ропрпЛ роЖро▓рпЛроЪройрпИ роЕроорпНроЪроорпН ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ ро╡ро░рпБроХро┐ро▒родрпБ...",
      logout: "ро╡рпЖро│ро┐ропрпЗро▒рпБ",
      tagline: "роЙроЩрпНроХро│рпН роХрпБроЯрпБроорпНрокродрпНродро┐ройрпН роЪрпБроХро╛родро╛ро░роорпН, роТро░рпБ родрпКроЯрпБродро▓рпБроХрпНроХрпБ роороЯрпНроЯрпБроорпЗ",
    },
    telugu: {
      bookAppointment: "р░Ер░кр░╛р░пр░┐р░Вр░Яр▒НтАМр░ор▒Жр░Вр░Яр▒Н р░мр▒Бр░Хр▒Н р░Ър▒Зр░пр░Вр░бр░┐",
      appointmentBookingComingSoon: "р░Ер░кр░╛р░пр░┐р░Вр░Яр▒НтАМр░ор▒Жр░Вр░Яр▒Н р░мр▒Бр░Хр░┐р░Вр░Чр▒Н р░лр▒Ар░Ър░░р▒Н р░др▒Нр░╡р░░р░▓р▒Л р░╡р░╕р▒Нр░др▒Лр░Вр░жр░┐...",
      telemedicine: "р░Яр▒Жр░▓р░┐р░ор▒Жр░бр░┐р░╕р░┐р░ир▒Н",
      videoConsultationComingSoon: "р░╡р▒Ар░бр░┐р░пр▒Л р░Хр░ир▒Нр░╕р░▓р▒Нр░Яр▒Зр░╖р░ир▒Н р░лр▒Ар░Ър░░р▒Н р░др▒Нр░╡р░░р░▓р▒Л р░╡р░╕р▒Нр░др▒Лр░Вр░жр░┐...",
      logout: "р░▓р░╛р░Чр▒Н р░Ер░╡р▒Бр░Яр▒Н",
      tagline: "р░ор▒А р░Хр▒Бр░Яр▒Бр░Вр░м р░Жр░░р▒Лр░Чр▒Нр░пр░В, р░Хр▒Зр░╡р░▓р░В р░Тр░Х р░ир▒Кр░Хр▒Нр░Хр▒Бр░др▒Лр░ир▒З",
    },
    bengali: {
      bookAppointment: "ржЕрзНржпрж╛ржкржпрж╝рзЗржирзНржЯржорзЗржирзНржЯ ржмрзБржХ ржХрж░рзБржи",
      appointmentBookingComingSoon: "ржЕрзНржпрж╛ржкржпрж╝рзЗржирзНржЯржорзЗржирзНржЯ ржмрзБржХрж┐ржВ ржлрж┐ржЪрж╛рж░ рж╢рзАржШрзНрж░ржЗ ржЖрж╕ржЫрзЗ...",
      telemedicine: "ржЯрзЗрж▓рж┐ржорзЗржбрж┐рж╕рж┐ржи",
      videoConsultationComingSoon: "ржнрж┐ржбрж┐ржУ ржкрж░рж╛ржорж░рзНрж╢ ржлрж┐ржЪрж╛рж░ рж╢рзАржШрзНрж░ржЗ ржЖрж╕ржЫрзЗ...",
      logout: "рж▓ржЧржЖржЙржЯ",
      tagline: "ржЖржкржирж╛рж░ ржкрж░рж┐ржмрж╛рж░рзЗрж░ рж╕рзНржмрж╛рж╕рзНржерзНржп, рж╢рзБржзрзБ ржПржХржЯрж┐ ржЯрзНржпрж╛ржкрзЗ",
    },
  };

  const getText = (key: keyof typeof texts.english): string => {
    return (
      texts[currentLanguage as keyof typeof texts]?.[key] ||
      texts.english[key]
    );
  };

  // If not logged in, show login page
  if (!isLoggedIn) {
    return <LoginPage onLogin={handleLogin} />;
  }

  const renderDashboardContent = () => {
    if (!user) return null;

    // Render user-specific dashboard based on user type
    switch (user.userType) {
      case "patient":
        return <PatientSpecificDashboard user={user as any} />;
      case "doctor":
        return <DoctorSpecificDashboard user={user as any} />;
      case "admin":
        return <AdminSpecificDashboard user={user as any} />;
      default:
        return <PatientSpecificDashboard user={user as any} />;
    }
  };

  const renderSectionContent = () => {
    switch (currentSection) {
      case "dashboard":
        return renderDashboardContent();
      case "aiChat":
        return (
          <AIChatAssistant
            isOpen={true}
            onClose={() => setCurrentSection("dashboard")}
            chatType="GENERAL_HEALTH"
          />
        );
      case "symptomChecker":
        return <SymptomChecker />;
      case "healthAnalytics":
        return <HealthAnalytics />;
      case "medicationManager":
        return <MedicationManager />;
      case "emergencySystem":
        return <EmergencySystem />;
      case "pwaFeatures":
        return <PWAFeatures />;
      case "iotDevices":
        return <IoTDeviceIntegration />;
      case "geneticInsights":
        return <GeneticHealthInsights />;
      case "wellnessCoaching":
        return <PersonalizedWellnessCoaching />;
      case "appointments":
        return (
          <div className="bg-white/50 backdrop-blur-sm rounded-3xl p-6 border border-white/20">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">
              {getText("bookAppointment")}
            </h2>
            <p className="text-gray-600">
              {getText("appointmentBookingComingSoon")}
            </p>
          </div>
        );
      case "telemedicine":
        return (
          <div className="bg-white/50 backdrop-blur-sm rounded-3xl p-6 border border-white/20">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">
              {getText("telemedicine")}
            </h2>
            <p className="text-gray-600">
              {getText("videoConsultationComingSoon")}
            </p>
          </div>
        );
      case "vitalsMonitoring":
        return <RemotePatientMonitoring />;
      case "education":
        return <PatientEducationLibrary />;
      case "governmentDashboard":
        return <GovernmentNGODashboard />;
      default:
        return renderDashboardContent();
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50">
      {/* Collapsible Sidebar */}
      <div
        className={`fixed left-0 top-0 h-full bg-white/90 backdrop-blur-xl border-r border-white/20 transition-all duration-300 z-40 ${
          sidebarOpen || sidebarHovered ? "w-80" : "w-16"
        }`}
        onMouseEnter={() => setSidebarHovered(true)}
        onMouseLeave={() => setSidebarHovered(false)}
      >
        <SidebarMenu
          isOpen={sidebarOpen || sidebarHovered}
          onClose={() => setSidebarOpen(false)}
          onNavigate={handleNavigation}
          currentSection={currentSection}
          userType={user?.userType || "patient"}
        />
      </div>

      {/* Main Content */}
      <div
        className={`transition-all duration-300 ${sidebarOpen || sidebarHovered ? "ml-80" : "ml-16"}`}
      >
        {/* Header */}
        <header
          className={`bg-white/80 backdrop-blur-xl border-b border-white/20 sticky z-30 px-4 lg:px-6 py-4 ${user?.userType === "admin" ? "top-20" : "top-0"}`}
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <button
                onClick={() => setSidebarOpen(true)}
                className="lg:hidden p-2 hover:bg-white/50 rounded-lg transition-all"
              >
                <span className="text-gray-600 text-xl">тШ░</span>
              </button>

              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center">
                  <span className="text-white text-xl">ЁЯПе</span>
                </div>
                <div>
                  <h1 className="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    EasyMed
                  </h1>
                  <p className="text-xs text-gray-500">
                    {getText("tagline")}
                  </p>
                </div>
              </div>
            </div>

            <div className="flex items-center space-x-4">
              {/* Language Selector */}
              <div className="relative">
                <select
                  value={currentLanguage}
                  onChange={(e) => {
                    const languageKey = e.target.value as keyof typeof Language;
                    setLanguage(Language[languageKey]);
                  }}
                  className="appearance-none bg-white/50 border border-gray-200 rounded-lg px-3 py-2 pr-8 text-sm font-medium text-gray-700 hover:bg-white/70 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer"
                >
                  <option value="English">ЁЯЗ║ЁЯЗ╕ English</option>
                  <option value="Hindi">ЁЯЗоЁЯЗ│ рд╣рд┐рдВрджреА</option>
                  <option value="Tamil">ЁЯЗоЁЯЗ│ родрооро┐ро┤рпН</option>
                  <option value="Telugu">ЁЯЗоЁЯЗ│ р░др▒Жр░▓р▒Бр░Чр▒Б</option>
                  <option value="Bengali">ЁЯЗоЁЯЗ│ ржмрж╛ржВрж▓рж╛</option>
                  <option value="Marathi">ЁЯЗоЁЯЗ│ рдорд░рд╛рдареА</option>
                  <option value="Punjabi">ЁЯЗоЁЯЗ│ рикрй░риЬри╛римрйА</option>
                  <option value="Gujarati">ЁЯЗоЁЯЗ│ ркЧрлБркЬрк░рк╛ркдрлА</option>
                  <option value="Kannada">ЁЯЗоЁЯЗ│ р▓Хр▓ир│Нр▓ир▓б</option>
                  <option value="Malayalam">ЁЯЗоЁЯЗ│ р┤ор┤▓р┤пр┤╛р┤│р┤В</option>
                  <option value="Odia">ЁЯЗоЁЯЗ│ рмУрмбрм╝рм┐рмЖ</option>
                  <option value="Assamese">ЁЯЗоЁЯЗ│ ржЕрж╕ржорзАржпрж╝рж╛</option>
                </select>
                <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                  <svg
                    className="w-4 h-4 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth="2"
                      d="M19 9l-7 7-7-7"
                    ></path>
                  </svg>
                </div>
              </div>

              {/* Logout Button */}
              <button
                onClick={() => {
                  // Clear local storage and reload page to reset state
                  localStorage.clear();
                  window.location.reload();
                }}
                className="p-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all duration-200 flex items-center space-x-2 text-sm"
                title="Logout"
              >
                <span>ЁЯЪк</span>
                <span className="hidden sm:inline">{getText("logout")}</span>
              </button>

              <button
                onClick={() => setShowChat(true)}
                className="p-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300"
              >
                <span className="text-xl">ЁЯдЦ</span>
              </button>
            </div>
          </div>
        </header>

        {/* Content Area */}
        <main className="p-4 lg:p-6">{renderSectionContent()}</main>
      </div>

      {/* Chat Assistant */}
      {showChat && (
        <AIChatAssistant
          isOpen={showChat}
          onClose={() => setShowChat(false)}
          chatType="GENERAL_HEALTH"
        />
      )}

      {/* Floating Elements */}
      <MovableFloatingButton onQuickAction={handleQuickAction} />

      <EnhancedVoiceAssistant onCommand={handleVoiceCommand} />
    </div>
  );
}
